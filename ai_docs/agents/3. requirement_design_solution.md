# Requirement Design Solution

Analyze a validated requirement together with the existing codebase to design the technical implementation.

## Input

The user will provide a requirement document path (should be already validated with `/requirement-validate`).

$ARGUMENTS

## Prerequisites

Before running this command:
1. The requirement should have been validated with `/requirement-validate`
2. All open questions should be resolved
3. The requirement should have status "Valid" or "Approved"

## Instructions

### Phase 1: Read Project Documentation

Read these documents first:
1. `/ai_docs/critical-rules.md` - MUST READ
2. `/ai_docs/architecture.md` - DDD and Hexagonal Architecture
3. `/ai_docs/application-layer.md` - CQRS patterns
4. `/ai_docs/infrastructure.md` - Repository patterns
5. `/ai_docs/code-quality.md` - Naming conventions

### Phase 2: Analyze Requirement

Read and understand the requirement document:
- Entities involved
- Use cases
- States and transitions
- Business rules
- Data requirements

### Phase 3: Explore Existing Codebase

Search for related existing code:

1. **Similar entities** - Find entities with similar patterns
2. **Existing bounded contexts** - Where does this feature belong?
3. **Shared infrastructure** - What can be reused?
4. **Related features** - What integrations are needed?

Use these search patterns:
- Look in `/src/` for domain code
- Look in `/app/Http/` for HTTP layer
- Check existing Commands, Queries, Events
- Review existing Repositories and Tables

### Phase 4: Identify Collateral Changes

Based on the requirement's collateral impact analysis:
- List ALL files that need modification
- Identify breaking changes
- Plan migration steps

### Phase 5: Design Solution

Following project architecture (DDD + Hexagonal + CQRS):

1. **Domain Layer** (`/src/[BoundedContext]/[Entity]/`)
    - Entities
    - Value Objects
    - Enums (Status, Types)
    - Domain Events
    - Repository Interfaces

2. **Application Layer** (`/src/[BoundedContext]/[Entity]/Application/`)
    - Commands + Handlers
    - Queries + Handlers
    - Event Handlers
    - Process Managers (if needed)

3. **Infrastructure Layer** (`/src/[BoundedContext]/[Entity]/Infrastructure/`)
    - Repository Implementations
    - Table classes
    - Hydrators
    - External service adapters

4. **HTTP Layer** (`/app/Http/`)
    - Actions (Controllers)
    - Requests (Validation)
    - Resources (Response transformation)
    - Routes

5. **Database**
    - Migrations
    - Seeders (if needed)

## Output Format

Generate a solution design document:

```markdown
# Solution Design: [Feature Name]

**Requirement:** [link to requirement]
**Date:** [date]
**Bounded Context:** [context name]

## Summary
[Brief description of the solution approach]

## Architecture Decision
[Why this approach was chosen, alternatives considered]

## Existing Code Analysis
| Component | Location | Reusable | Modifications Needed |
|-----------|----------|----------|---------------------|

## Implementation Plan

### 1. Domain Layer

#### Entities
| Entity | File Path | Description |
|--------|-----------|-------------|

#### Value Objects
| VO | File Path | Description |
|----|-----------|-------------|

#### Enums
| Enum | File Path | Values |
|------|-----------|--------|
| [Entity]Status | /src/.../Domain/[Entity]Status.php | pending, confirmed, cancelled, ... |

#### Domain Events
| Event | Trigger | Payload |
|-------|---------|---------|

### 2. Application Layer

#### Commands
| Command | Handler | Description |
|---------|---------|-------------|
| Create[Entity]Command | Create[Entity]Handler | Creates new [entity] |

#### Queries
| Query | Handler | Description |
|-------|---------|-------------|
| Get[Entity]ByIdQuery | Get[Entity]ByIdHandler | Retrieves [entity] by ID |

#### Event Handlers
| Handler | Listens To | Action |
|---------|------------|--------|

### 3. Infrastructure Layer

#### Repository
| Interface | Implementation | Table |
|-----------|----------------|-------|

#### Migrations
| Migration | Description |
|-----------|-------------|

### 4. HTTP Layer

#### Endpoints
| Method | Route | Action | Request | Resource |
|--------|-------|--------|---------|----------|
| POST | /api/[entities] | Create[Entity]Action | Create[Entity]Request | [Entity]Resource |

### 5. Collateral Changes

#### Files to Modify
| File | Change Type | Description |
|------|-------------|-------------|

#### Breaking Changes
| Change | Impact | Migration |
|--------|--------|-----------|

## Database Schema

```sql
CREATE TABLE [table_name] (
    ...
);
```

## State Machine

```
[Initial] → State1 → State2 → [Final]
              ↓
           State3
```

## Dependencies
| Dependency | Type | Description |
|------------|------|-------------|

## Testing Strategy
| Test Type | Scope | Priority |
|-----------|-------|----------|
| Unit | Domain entities | High |
| Integration | Repository | High |
| Feature | HTTP endpoints | Medium |

## Implementation Order
1. [ ] Domain: Enums and Value Objects
2. [ ] Domain: Entity
3. [ ] Infrastructure: Migration
4. [ ] Infrastructure: Table + Repository
5. [ ] Application: Commands
6. [ ] Application: Queries
7. [ ] HTTP: Actions + Requests + Resources
8. [ ] Tests
9. [ ] Collateral changes
10. [ ] PHPStan validation

## Open Technical Questions
1. [Question about implementation detail]

## Risks
| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
```

## Important Notes

- Follow existing project patterns and conventions
- Reference similar implementations in codebase
- Consider performance implications (see critical-rules.md)
- Ensure CQRS separation (Commands vs Queries)
- Plan for backwards compatibility where needed