# Check Architecture Agent

Review code changes to ensure they comply with the project's DDD, Hexagonal, and CQRS architecture.

## Purpose

Validate that new or modified code follows the established architectural patterns and doesn't introduce violations that compromise the system's maintainability.

## When to Use

Run this agent:
- After implementing a feature
- During code review
- Before merging to main branch
- When refactoring existing code

## Prerequisites

Read first:
1. `/ai_docs/architecture/architecture.md` - DDD and Hexagonal overview
2. `/ai_docs/architecture/critical-rules.md` - Critical rules
3. `/ai_docs/architecture/application-layer.md` - CQRS patterns
4. `/ai_docs/architecture/http-layer-actions.md` - Action patterns
5. `/ai_docs/architecture/http-requests-pattern.md` - Request patterns

## Input

- Files to review (paths or git diff)
- Or: entire feature branch

## Instructions

### Step 1: Identify Layer for Each File

Classify each file by architectural layer:

| Path Pattern | Layer | Allowed Dependencies |
|--------------|-------|---------------------|
| `src/*/Domain/` | Domain | None (pure) |
| `src/*/Application/` | Application | Domain |
| `src/*/Infrastructure/` | Infrastructure | Domain, Application |
| `app/Http/` | HTTP | Application, Domain types |

### Step 2: Verify Layer Dependencies

**Domain Layer Rules:**
- [ ] No imports from Infrastructure
- [ ] No imports from Application (except interfaces)
- [ ] No framework dependencies
- [ ] No database access
- [ ] No external service calls

**Application Layer Rules:**
- [ ] Only imports Domain layer
- [ ] Commands return void
- [ ] Queries return DTOs/ReadModels
- [ ] Handlers are stateless

**Infrastructure Layer Rules:**
- [ ] Implements Domain interfaces
- [ ] Can use framework/ORM
- [ ] Database access only here
- [ ] External services only here

**HTTP Layer Rules:**
- [ ] Actions are thin (max 20 lines)
- [ ] No business logic in Actions
- [ ] No database access in Actions
- [ ] Requests only have getDto() (NO rules())
- [ ] Returns Resource, not JsonResponse

### Step 3: Verify CQRS Patterns

**Commands:**
- [ ] Extend/Implement CommandInterface
- [ ] Have corresponding Handler
- [ ] Handler returns void
- [ ] ID passed in, not generated in handler

**Queries:**
- [ ] Extend/Implement QueryInterface
- [ ] Have corresponding Handler
- [ ] Handler returns DTO/ReadModel
- [ ] No side effects

### Step 4: Verify DDD Patterns

**Entities:**
- [ ] Have ID value object
- [ ] Have static create() factory
- [ ] State changes via methods, not setters
- [ ] Domain events recorded
- [ ] No anemic entities (has business logic)

**Value Objects:**
- [ ] Immutable (readonly)
- [ ] Equality by value
- [ ] Self-validating

**Repositories:**
- [ ] Interface in Domain
- [ ] Implementation in Infrastructure
- [ ] Returns entities/DTOs, not raw data

### Step 5: Verify Bounded Context Rules

- [ ] No direct access to other BC's repositories
- [ ] Cross-BC communication via Query/Command Bus
- [ ] Shared kernel items in Shared folder

### Step 6: Check for Anti-Patterns

**Anti-Pattern Checklist:**
- [ ] No Service Locator pattern
- [ ] No God classes
- [ ] No circular dependencies
- [ ] No leaky abstractions
- [ ] No business logic in controllers
- [ ] No database queries in loops

## Output Format

```markdown
# Architecture Review Report

**Files Reviewed:** [count]
**Date:** [date]
**Status:** PASS | FAIL | WARNINGS

---

## Summary

| Category | Status | Violations |
|----------|--------|------------|
| Layer Dependencies | PASS/FAIL | [count] |
| CQRS Compliance | PASS/FAIL | [count] |
| DDD Patterns | PASS/FAIL | [count] |
| BC Boundaries | PASS/FAIL | [count] |
| Anti-Patterns | PASS/FAIL | [count] |

---

## File Analysis

### [file path]
**Layer:** Domain | Application | Infrastructure | HTTP
**Status:** PASS | FAIL

#### Violations
| Rule | Line | Issue | Severity |
|------|------|-------|----------|
| [rule] | [line] | [description] | Critical/High/Medium/Low |

#### Recommendations
- [recommendation]

---

## 1. Layer Dependency Violations

### Critical (Must Fix)

#### [file:line]
**Violation:** [description]
**Rule:** [which rule is broken]
**Fix:** [how to fix]

### High Priority

#### [file:line]
**Violation:** [description]
**Fix:** [how to fix]

---

## 2. CQRS Violations

### Commands
| Command | Issue | Fix |
|---------|-------|-----|
| [command] | [issue] | [fix] |

### Queries
| Query | Issue | Fix |
|-------|-------|-----|
| [query] | [issue] | [fix] |

---

## 3. DDD Pattern Violations

### Entities
| Entity | Issue | Fix |
|--------|-------|-----|
| [entity] | [issue] | [fix] |

### Repositories
| Repository | Issue | Fix |
|------------|-------|-----|
| [repo] | [issue] | [fix] |

---

## 4. Bounded Context Violations

| BC | Violation | Fix |
|----|-----------|-----|
| [bc] | [violation] | [fix] |

---

## 5. Anti-Patterns Detected

| Pattern | Location | Impact | Fix |
|---------|----------|--------|-----|
| [pattern] | [file:line] | [impact] | [fix] |

---

## Architecture Diagram (if applicable)

```
[Diagram showing correct architecture vs current implementation]
```

---

## Recommendations

### Must Fix (Blocking)
1. [Critical violation 1]
2. [Critical violation 2]

### Should Fix (Non-Blocking)
1. [High priority issue 1]
2. [High priority issue 2]

### Consider (Improvements)
1. [Suggestion 1]
2. [Suggestion 2]

---

## References

- [Link to relevant architecture doc]
- [Link to example of correct implementation]
```

## Severity Levels

| Severity | Description | Action |
|----------|-------------|--------|
| **Critical** | Breaks architecture fundamentally | Must fix before merge |
| **High** | Significant violation | Should fix before merge |
| **Medium** | Minor violation | Fix in follow-up |
| **Low** | Style/convention | Optional fix |

## Common Violations

### 1. Database Access in Handler
```
// WRONG
class CreateUserHandler:
    function invoke(cmd):
        db.table('users').insert(...)  // Direct DB access!

// CORRECT
class CreateUserHandler:
    function invoke(cmd):
        user = User.create(...)
        repository.save(user)  // Via repository
```

### 2. Business Logic in Action
```
// WRONG
class CreateOrderAction:
    function invoke(dto):
        if dto.items.count() > 10:  // Business logic!
            throw TooManyItemsException()

// CORRECT
class CreateOrderAction:
    function invoke(dto):
        commandBus.dispatch(new CreateOrderCommand(...))
        // Validation in Handler or Entity
```

### 3. Framework Validation in Request
```
// WRONG
class CreateUserRequest:
    function rules(): array { ... }  // NO!

// CORRECT
class CreateUserRequest:
    function getDto(): CreateUserDto { ... }  // Only this
```

### 4. Command Returns Value
```
// WRONG
class CreateUserHandler:
    function invoke(cmd): UserId  // Returns something!

// CORRECT
class CreateUserHandler:
    function invoke(cmd): void  // Always void
```
