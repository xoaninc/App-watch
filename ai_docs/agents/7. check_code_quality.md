# Check Code Quality Agent

Review code for quality issues, SOLID principles compliance, naming conventions, and best practices.

## Purpose

Ensure code is clean, maintainable, readable, and follows established coding standards and SOLID principles.

## When to Use

Run this agent:
- After implementing a feature
- During code review
- When refactoring code
- Before merging to main branch

## Prerequisites

Read first:
1. `/ai_docs/architecture/code-quality.md` - SOLID and best practices
2. `/ai_docs/architecture/critical-rules.md` - Critical rules

## Input

- Files to review (paths or git diff)
- Or: entire feature branch

## Instructions

### Step 1: SOLID Principles Check

#### Single Responsibility (SRP)
- [ ] Each class solves ONE problem
- [ ] Methods are focused
- [ ] No "God" classes

#### Open/Closed (OCP)
- [ ] Classes open for extension
- [ ] Classes closed for modification
- [ ] Uses interfaces/abstractions

#### Liskov Substitution (LSP)
- [ ] Subtypes replaceable for base types
- [ ] No broken contracts

#### Interface Segregation (ISP)
- [ ] Interfaces are focused
- [ ] No "fat" interfaces
- [ ] Clients don't depend on unused methods

#### Dependency Inversion (DIP)
- [ ] Depends on abstractions
- [ ] Not on concretions
- [ ] Constructor injection used

### Step 2: Naming Conventions

**Classes:**
- [ ] PascalCase
- [ ] Descriptive (what it does)
- [ ] Consistent suffixes (Repository, Handler, Service)

**Methods:**
- [ ] camelCase or snake_case (consistent)
- [ ] Verb-based (getUser, createOrder)
- [ ] Boolean prefixes (isActive, hasPermission, canEdit)

**Variables:**
- [ ] Descriptive names
- [ ] No single letters (except loops)
- [ ] No abbreviations (user, not usr)

**Files:**
- [ ] Match class name
- [ ] Lowercase with separators for non-class files

### Step 3: Code Smells Detection

**Check for:**
- [ ] Long methods (> 20 lines)
- [ ] Long parameter lists (> 4 params)
- [ ] Duplicate code
- [ ] Deep nesting (> 3 levels)
- [ ] Magic numbers/strings
- [ ] Dead code
- [ ] Comments explaining bad code

### Step 4: Error Handling

- [ ] Exceptions used properly
- [ ] No empty catch blocks
- [ ] Specific exception types
- [ ] Error messages are helpful
- [ ] No swallowed exceptions

### Step 5: Type Safety

- [ ] Type hints on parameters
- [ ] Return type declarations
- [ ] Nullable types explicit (?Type)
- [ ] No mixed types where avoidable
- [ ] Arrays typed with generics

### Step 6: Immutability & State

- [ ] Value objects are immutable
- [ ] Readonly where appropriate
- [ ] No unexpected side effects
- [ ] State changes are explicit

### Step 7: Dependencies

- [ ] Constructor injection only
- [ ] No service locator
- [ ] Minimal dependencies per class
- [ ] Dependencies are interfaces

### Step 8: Documentation

- [ ] Complex logic explained
- [ ] Public APIs documented
- [ ] No obvious comments
- [ ] TODOs have ticket references

## Output Format

```markdown
# Code Quality Report

**Files Reviewed:** [count]
**Date:** [date]
**Status:** PASS | FAIL | WARNINGS

---

## Summary

| Category | Status | Issues |
|----------|--------|--------|
| SOLID Principles | PASS/FAIL | [count] |
| Naming Conventions | PASS/FAIL | [count] |
| Code Smells | PASS/FAIL | [count] |
| Error Handling | PASS/FAIL | [count] |
| Type Safety | PASS/FAIL | [count] |
| Dependencies | PASS/FAIL | [count] |

---

## Issue Statistics

| Severity | Count |
|----------|-------|
| Critical | X |
| High | X |
| Medium | X |
| Low | X |

---

## File-by-File Analysis

### [file path]

**Quality Score:** X/10
**Lines of Code:** X

#### Issues

| Line | Issue | Severity | Category |
|------|-------|----------|----------|
| [line] | [description] | [severity] | [category] |

#### Positive Observations
- [What's done well]

---

## 1. SOLID Violations

### SRP Violations
| File | Class | Issue | Suggestion |
|------|-------|-------|------------|
| [file] | [class] | [doing too much] | [split into...] |

### DIP Violations
| File | Issue | Fix |
|------|-------|-----|
| [file] | [concrete dependency] | [inject interface] |

---

## 2. Naming Issues

| File | Line | Current | Suggested | Reason |
|------|------|---------|-----------|--------|
| [file] | [line] | `$usr` | `$user` | Avoid abbreviations |
| [file] | [line] | `getData()` | `getUserById()` | Be specific |

---

## 3. Code Smells

### Long Methods
| File | Method | Lines | Suggestion |
|------|--------|-------|------------|
| [file] | [method] | [X lines] | [split into...] |

### Duplicate Code
| Location 1 | Location 2 | Lines | Suggestion |
|------------|------------|-------|------------|
| [file:line] | [file:line] | [X lines] | [extract to...] |

### Deep Nesting
| File | Line | Depth | Suggestion |
|------|------|-------|------------|
| [file] | [line] | [X levels] | [early return, extract method] |

### Magic Values
| File | Line | Value | Suggestion |
|------|------|-------|------------|
| [file] | [line] | `86400` | `SECONDS_PER_DAY` constant |

---

## 4. Error Handling Issues

| File | Line | Issue | Fix |
|------|------|-------|-----|
| [file] | [line] | Empty catch block | Handle or rethrow |
| [file] | [line] | Generic exception | Use specific type |

---

## 5. Type Safety Issues

| File | Line | Issue | Fix |
|------|------|-------|-----|
| [file] | [line] | Missing return type | Add `: void` |
| [file] | [line] | Untyped array | Use `array<Item>` |

---

## 6. Documentation Issues

| File | Line | Issue |
|------|------|-------|
| [file] | [line] | Complex logic undocumented |
| [file] | [line] | TODO without ticket |

---

## Recommendations

### Must Fix (Critical/High)
1. [Issue with explanation]
2. [Issue with explanation]

### Should Fix (Medium)
1. [Issue with explanation]
2. [Issue with explanation]

### Nice to Have (Low)
1. [Suggestion]
2. [Suggestion]

---

## Code Examples

### Before/After: [Issue Type]

**Before (Bad):**
```
[bad code example from review]
```

**After (Good):**
```
[corrected code example]
```

---

## Metrics

| Metric | Value | Target | Status |
|--------|-------|--------|--------|
| Average Method Length | X lines | < 20 | OK/WARN |
| Max Nesting Depth | X | < 4 | OK/WARN |
| Cyclomatic Complexity | X | < 10 | OK/WARN |
```

## Severity Definitions

| Severity | Impact | Fix When |
|----------|--------|----------|
| **Critical** | Bugs, security issues | Immediately |
| **High** | Maintainability risks | Before merge |
| **Medium** | Code smells | Soon |
| **Low** | Style issues | When convenient |

## Common Issues & Fixes

### 1. God Class
```
// BAD: Does everything
class UserManager:
    createUser()
    deleteUser()
    sendEmail()
    generateReport()
    processPayment()

// GOOD: Split responsibilities
class UserRepository: createUser(), deleteUser()
class UserNotificationService: sendEmail()
class UserReportService: generateReport()
class PaymentService: processPayment()
```

### 2. Long Method
```
// BAD: 50 lines doing many things
function processOrder():
    // validate
    // calculate
    // save
    // notify
    // log

// GOOD: Extract methods
function processOrder():
    validateOrder()
    total = calculateTotal()
    saveOrder()
    notifyCustomer()
    logTransaction()
```

### 3. Magic Numbers
```
// BAD
if timeDiff > 86400:
    expire()

// GOOD
SECONDS_PER_DAY = 86400
if timeDiff > SECONDS_PER_DAY:
    expire()
```

### 4. Deep Nesting
```
// BAD
if user:
    if user.isActive:
        if user.hasPermission:
            doSomething()

// GOOD - Early returns
if not user: return
if not user.isActive: return
if not user.hasPermission: return
doSomething()
```
